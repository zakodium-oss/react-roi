import{j as d}from"./jsx-runtime-ed146b25.js";import{r as l,R as Rt}from"./index-c6dae603.js";const E={ctrl:!1,shift:void 0,alt:!1};function Oe(e){const t=[];for(const n of e)for(const r of n){const[i,...o]=Ct(r.shortcut);t.push({shortcut:i,aliases:o,handler:r.handler,meta:r.meta,maxFrequency:r.maxFrequency??0})}return t}function Ct(e){return typeof e=="string"?[{...E,key:e.toLowerCase()}]:Array.isArray(e)?e.map(t=>typeof t=="string"?{...E,key:t.toLowerCase()}:"key"in t?{...E,...t,key:t.key.toLowerCase()}:{...E,...t,code:t.code.toLowerCase()}):"key"in e?[{...E,...e,key:e.key.toLowerCase()}]:[{...E,...e,code:e.code.toLowerCase()}]}const Et=typeof navigator<"u"&&navigator.platform==="MacIntel";function Ot(e){return Et?e.metaKey:e.ctrlKey}function St(e){return[...Se(e.shortcut),...e.aliases.map(Se).flat()]}function Se(e){const t=`ctrl[${O(e.ctrl)}]_alt[${O(e.alt)}]`;let n;return"key"in e?n=`key[${e.key}]_${t}`:n=`code[${e.code}]_${t}`,typeof e.shift=="boolean"?[`${n}_shift[${O(e.shift)}]`]:[`${n}_shift[true]`,`${n}_shift[false]`]}function zt(e){const t=`ctrl[${O(Ot(e))}]_alt[${O(e.altKey)}]_shift[${O(e.shiftKey)}]`;return{key:`key[${e.key.toLowerCase()}]_${t}`,code:`code[${e.code.toLowerCase()}]_${t}`}}function O(e){return e?"true":"false"}function ze(e){const t={};for(const n of e){const r=St(n);for(const i of r)t[i]!==void 0&&console.warn(`A global shortcut was already defined for key the combination ${i}. It will be overridden.`),t[i]=n}return t}const Pt=new Set(["INPUT","TEXTAREA","SELECT"]);function Tt(e){return Pt.has(e.tagName)||e.isContentEditable||e.hasAttribute("data-kbs-ignore")}function kt(){return l.useRef({keyOrCode:"",timestamp:0})}function At(e,t){return function(r){if(Tt(r.target))return;const{key:i,code:o}=zt(r);let s,c;if(t[i]?(c=t[i],s=i):(c=t[o],s=o),c){if(r.stopPropagation(),r.preventDefault(),c.maxFrequency>0){const a=performance.now();if(r.repeat&&e.current.keyOrCode===s&&a-e.current.timestamp<1e3/c.maxFrequency)return;e.current={keyOrCode:s,timestamp:a}}c.handler(r)}}}const Ue={inputShortcuts:[],cleanedShortcuts:[],combinedShortcuts:{},disableCount:0},Dt=l.createContext(Ue),He=l.createContext(null);function Bt(){const e=l.useContext(He);if(!e)throw new Error("missing context");return e}function It(e,t){switch(t.type){case"INIT":{const n=[...e.inputShortcuts,t.shortcuts],r=Oe(n);return{...e,inputShortcuts:n,cleanedShortcuts:r,combinedShortcuts:ze(r)}}case"CLEANUP":{const n=e.inputShortcuts.filter(i=>i!==t.shortcuts),r=Oe(n);return{...e,inputShortcuts:n,cleanedShortcuts:r,combinedShortcuts:ze(r)}}case"DISABLE_GLOBAL":return{...e,disableCount:e.disableCount+1};case"ENABLE_GLOBAL":return{...e,disableCount:e.disableCount-1};default:throw new Error("unreachable")}}function Mt(e){const[t,n]=l.useReducer(It,Ue),r=kt();return l.useEffect(()=>{if(t.disableCount!==0)return;const i=At(r,t.combinedShortcuts);return document.body.addEventListener("keydown",i),()=>document.body.removeEventListener("keydown",i)},[t.disableCount,t.combinedShortcuts,r]),d.jsx(Dt.Provider,{value:t,children:d.jsx(He.Provider,{value:n,children:e.children})})}function Nt(e){const t=Bt();l.useEffect(()=>(t({type:"INIT",shortcuts:e}),()=>t({type:"CLEANUP",shortcuts:e})),[t,e])}const Ye=l.createContext(null),Ge=l.createContext(null),Lt=l.createContext(null),Je=l.createContext(null),Ft=l.createContext(null),Qe=l.createContext({scale:1.5,translation:[0,0]});function W(){const e=l.useContext(Ge);if(!e)throw new Error("roiDispatchContext is not defined, please check if you are using RoiProvider");return e}var x=[],$t=function(){return x.some(function(e){return e.activeTargets.length>0})},jt=function(){return x.some(function(e){return e.skippedTargets.length>0})},Pe="ResizeObserver loop completed with undelivered notifications.",Zt=function(){var e;typeof ErrorEvent=="function"?e=new ErrorEvent("error",{message:Pe}):(e=document.createEvent("Event"),e.initEvent("error",!1,!1),e.message=Pe),window.dispatchEvent(e)},k;(function(e){e.BORDER_BOX="border-box",e.CONTENT_BOX="content-box",e.DEVICE_PIXEL_CONTENT_BOX="device-pixel-content-box"})(k||(k={}));var w=function(e){return Object.freeze(e)},qt=function(){function e(t,n){this.inlineSize=t,this.blockSize=n,w(this)}return e}(),et=function(){function e(t,n,r,i){return this.x=t,this.y=n,this.width=r,this.height=i,this.top=this.y,this.left=this.x,this.bottom=this.top+this.height,this.right=this.left+this.width,w(this)}return e.prototype.toJSON=function(){var t=this,n=t.x,r=t.y,i=t.top,o=t.right,s=t.bottom,c=t.left,a=t.width,u=t.height;return{x:n,y:r,top:i,right:o,bottom:s,left:c,width:a,height:u}},e.fromRect=function(t){return new e(t.x,t.y,t.width,t.height)},e}(),ve=function(e){return e instanceof SVGElement&&"getBBox"in e},tt=function(e){if(ve(e)){var t=e.getBBox(),n=t.width,r=t.height;return!n&&!r}var i=e,o=i.offsetWidth,s=i.offsetHeight;return!(o||s||e.getClientRects().length)},Te=function(e){var t;if(e instanceof Element)return!0;var n=(t=e==null?void 0:e.ownerDocument)===null||t===void 0?void 0:t.defaultView;return!!(n&&e instanceof n.Element)},Vt=function(e){switch(e.tagName){case"INPUT":if(e.type!=="image")break;case"VIDEO":case"AUDIO":case"EMBED":case"OBJECT":case"CANVAS":case"IFRAME":case"IMG":return!0}return!1},T=typeof window<"u"?window:{},F=new WeakMap,ke=/auto|scroll/,Xt=/^tb|vertical/,Kt=/msie|trident/i.test(T.navigator&&T.navigator.userAgent),g=function(e){return parseFloat(e||"0")},S=function(e,t,n){return e===void 0&&(e=0),t===void 0&&(t=0),n===void 0&&(n=!1),new qt((n?t:e)||0,(n?e:t)||0)},Ae=w({devicePixelContentBoxSize:S(),borderBoxSize:S(),contentBoxSize:S(),contentRect:new et(0,0,0,0)}),nt=function(e,t){if(t===void 0&&(t=!1),F.has(e)&&!t)return F.get(e);if(tt(e))return F.set(e,Ae),Ae;var n=getComputedStyle(e),r=ve(e)&&e.ownerSVGElement&&e.getBBox(),i=!Kt&&n.boxSizing==="border-box",o=Xt.test(n.writingMode||""),s=!r&&ke.test(n.overflowY||""),c=!r&&ke.test(n.overflowX||""),a=r?0:g(n.paddingTop),u=r?0:g(n.paddingRight),f=r?0:g(n.paddingBottom),y=r?0:g(n.paddingLeft),J=r?0:g(n.borderTopWidth),mt=r?0:g(n.borderRightWidth),vt=r?0:g(n.borderBottomWidth),gt=r?0:g(n.borderLeftWidth),xe=y+u,we=a+f,Q=gt+mt,ee=J+vt,Re=c?e.offsetHeight-ee-e.clientHeight:0,Ce=s?e.offsetWidth-Q-e.clientWidth:0,bt=i?xe+Q:0,_t=i?we+ee:0,N=r?r.width:g(n.width)-bt-Ce,L=r?r.height:g(n.height)-_t-Re,xt=N+xe+Ce+Q,wt=L+we+Re+ee,Ee=w({devicePixelContentBoxSize:S(Math.round(N*devicePixelRatio),Math.round(L*devicePixelRatio),o),borderBoxSize:S(xt,wt,o),contentBoxSize:S(N,L,o),contentRect:new et(y,a,N,L)});return F.set(e,Ee),Ee},rt=function(e,t,n){var r=nt(e,n),i=r.borderBoxSize,o=r.contentBoxSize,s=r.devicePixelContentBoxSize;switch(t){case k.DEVICE_PIXEL_CONTENT_BOX:return s;case k.BORDER_BOX:return i;default:return o}},Wt=function(){function e(t){var n=nt(t);this.target=t,this.contentRect=n.contentRect,this.borderBoxSize=w([n.borderBoxSize]),this.contentBoxSize=w([n.contentBoxSize]),this.devicePixelContentBoxSize=w([n.devicePixelContentBoxSize])}return e}(),it=function(e){if(tt(e))return 1/0;for(var t=0,n=e.parentNode;n;)t+=1,n=n.parentNode;return t},Ut=function(){var e=1/0,t=[];x.forEach(function(s){if(s.activeTargets.length!==0){var c=[];s.activeTargets.forEach(function(u){var f=new Wt(u.target),y=it(u.target);c.push(f),u.lastReportedSize=rt(u.target,u.observedBox),y<e&&(e=y)}),t.push(function(){s.callback.call(s.observer,c,s.observer)}),s.activeTargets.splice(0,s.activeTargets.length)}});for(var n=0,r=t;n<r.length;n++){var i=r[n];i()}return e},De=function(e){x.forEach(function(n){n.activeTargets.splice(0,n.activeTargets.length),n.skippedTargets.splice(0,n.skippedTargets.length),n.observationTargets.forEach(function(i){i.isActive()&&(it(i.target)>e?n.activeTargets.push(i):n.skippedTargets.push(i))})})},Ht=function(){var e=0;for(De(e);$t();)e=Ut(),De(e);return jt()&&Zt(),e>0},te,ot=[],Yt=function(){return ot.splice(0).forEach(function(e){return e()})},Gt=function(e){if(!te){var t=0,n=document.createTextNode(""),r={characterData:!0};new MutationObserver(function(){return Yt()}).observe(n,r),te=function(){n.textContent="".concat(t?t--:t++)}}ot.push(e),te()},Jt=function(e){Gt(function(){requestAnimationFrame(e)})},V=0,Qt=function(){return!!V},en=250,tn={attributes:!0,characterData:!0,childList:!0,subtree:!0},Be=["resize","load","transitionend","animationend","animationstart","animationiteration","keyup","keydown","mouseup","mousedown","mouseover","mouseout","blur","focus"],Ie=function(e){return e===void 0&&(e=0),Date.now()+e},ne=!1,nn=function(){function e(){var t=this;this.stopped=!0,this.listener=function(){return t.schedule()}}return e.prototype.run=function(t){var n=this;if(t===void 0&&(t=en),!ne){ne=!0;var r=Ie(t);Jt(function(){var i=!1;try{i=Ht()}finally{if(ne=!1,t=r-Ie(),!Qt())return;i?n.run(1e3):t>0?n.run(t):n.start()}})}},e.prototype.schedule=function(){this.stop(),this.run()},e.prototype.observe=function(){var t=this,n=function(){return t.observer&&t.observer.observe(document.body,tn)};document.body?n():T.addEventListener("DOMContentLoaded",n)},e.prototype.start=function(){var t=this;this.stopped&&(this.stopped=!1,this.observer=new MutationObserver(this.listener),this.observe(),Be.forEach(function(n){return T.addEventListener(n,t.listener,!0)}))},e.prototype.stop=function(){var t=this;this.stopped||(this.observer&&this.observer.disconnect(),Be.forEach(function(n){return T.removeEventListener(n,t.listener,!0)}),this.stopped=!0)},e}(),se=new nn,Me=function(e){!V&&e>0&&se.start(),V+=e,!V&&se.stop()},rn=function(e){return!ve(e)&&!Vt(e)&&getComputedStyle(e).display==="inline"},on=function(){function e(t,n){this.target=t,this.observedBox=n||k.CONTENT_BOX,this.lastReportedSize={inlineSize:0,blockSize:0}}return e.prototype.isActive=function(){var t=rt(this.target,this.observedBox,!0);return rn(this.target)&&(this.lastReportedSize=t),this.lastReportedSize.inlineSize!==t.inlineSize||this.lastReportedSize.blockSize!==t.blockSize},e}(),sn=function(){function e(t,n){this.activeTargets=[],this.skippedTargets=[],this.observationTargets=[],this.observer=t,this.callback=n}return e}(),$=new WeakMap,Ne=function(e,t){for(var n=0;n<e.length;n+=1)if(e[n].target===t)return n;return-1},j=function(){function e(){}return e.connect=function(t,n){var r=new sn(t,n);$.set(t,r)},e.observe=function(t,n,r){var i=$.get(t),o=i.observationTargets.length===0;Ne(i.observationTargets,n)<0&&(o&&x.push(i),i.observationTargets.push(new on(n,r&&r.box)),Me(1),se.schedule())},e.unobserve=function(t,n){var r=$.get(t),i=Ne(r.observationTargets,n),o=r.observationTargets.length===1;i>=0&&(o&&x.splice(x.indexOf(r),1),r.observationTargets.splice(i,1),Me(-1))},e.disconnect=function(t){var n=this,r=$.get(t);r.observationTargets.slice().forEach(function(i){return n.unobserve(t,i.target)}),r.activeTargets.splice(0,r.activeTargets.length)},e}(),cn=function(){function e(t){if(arguments.length===0)throw new TypeError("Failed to construct 'ResizeObserver': 1 argument required, but only 0 present.");if(typeof t!="function")throw new TypeError("Failed to construct 'ResizeObserver': The callback provided as parameter 1 is not a function.");j.connect(this,t)}return e.prototype.observe=function(t,n){if(arguments.length===0)throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!Te(t))throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': parameter 1 is not of type 'Element");j.observe(this,t,n)},e.prototype.unobserve=function(t){if(arguments.length===0)throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!Te(t))throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': parameter 1 is not of type 'Element");j.unobserve(this,t)},e.prototype.disconnect=function(){j.disconnect(this)},e.toString=function(){return"function ResizeObserver () { [polyfill code] }"},e}();const an=Rt[typeof document<"u"&&document.createElement!==void 0?"useLayoutEffect":"useEffect"],un=an,ln=e=>{const t=l.useRef(e);return l.useEffect(()=>{t.current=e}),t},dn=ln,fn=typeof window<"u"&&"ResizeObserver"in window?window.ResizeObserver:cn;function hn(){}function pn(e,t){const n=mn(),r=dn(t);return un(()=>{let i=!1;const o=e&&"current"in e?e.current:e;if(!o)return hn;function s(c,a){i||r.current(c,a)}return n.subscribe(o,s),()=>{i=!0,n.unsubscribe(o,s)}},[e,n,r]),n.observer}function yn(){let e=!1,t=[];const n=new Map,r=new fn((i,o)=>{t=t.concat(i);function s(){const c=new Set;for(let a=0;a<t.length;a++){if(c.has(t[a].target))continue;c.add(t[a].target);const u=n.get(t[a].target);u==null||u.forEach(f=>f(t[a],o))}t=[],e=!1}e||window.requestAnimationFrame(s),e=!0});return{observer:r,subscribe(i,o){var s;r.observe(i);const c=(s=n.get(i))!==null&&s!==void 0?s:[];c.push(o),n.set(i,c)},unsubscribe(i,o){var s;const c=(s=n.get(i))!==null&&s!==void 0?s:[];if(c.length===1){r.unobserve(i),n.delete(i);return}const a=c.indexOf(o);a!==-1&&c.splice(a,1),n.set(i,c)}}}let re;const mn=()=>re||(re=yn());function ge(){const e=l.useContext(Ye);if(!e)throw new Error("useRoiState must be used within a RoiProvider");return e}function vn(){const e=l.useContext(Je);if(!e)throw new Error("useRois must be used within a RoiProvider");return e}function gn(){return l.useContext(Qe)}function bn(){const{scale:e,translation:t}=gn();return`matrix(${e}, 0, 0, ${e}, ${t[0]}, ${t[1]})`}function _n(e,t){let n=0;return function(...i){const o=new Date().getTime();o-n>=t&&(e(...i),n=o)}}function ce({target:e,children:t,id:n}){const r=W(),i=ge(),o=bn(),s=l.useRef(null),c=l.useMemo(()=>_n(a=>{a.altKey&&(a.stopPropagation(),r({type:"ZOOM",payload:{scale:a.deltaY>0?.92:1/.92,clientX:a.clientX,clientY:a.clientY,refBoundingClientRect:s.current.getBoundingClientRect()}}))},25),[r]);return pn(s,a=>{r({type:"SET_SIZE",payload:{width:a.contentRect.width,height:a.contentRect.height}})}),l.useEffect(()=>{function a(f){r({type:"MOUSE_MOVE",payload:f})}function u(){r({type:"END_ACTION"})}return document.addEventListener("mousemove",a),document.addEventListener("mouseup",u),()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)}}),d.jsx(Ft.Provider,{value:s,children:d.jsx("div",{id:n,ref:s,style:{position:"relative",overflow:"hidden",margin:0,padding:0,cursor:i.mode==="draw"?"crosshair":"default",userSelect:"none"},onDoubleClick:()=>{r({type:"RESET_ZOOM"})},onWheel:c,onMouseDown:a=>{const u=s.current.getBoundingClientRect();r({type:"START_DRAW",payload:{event:a,containerBoundingRect:u,isPanZooming:a.altKey}})},children:d.jsxs("div",{style:{transform:o,transformOrigin:"0 0"},children:[e,d.jsx("div",{style:{userSelect:"none",width:"100%",height:"100%",position:"absolute",margin:0,padding:0,top:0,left:0},children:t})]})})})}try{ce.displayName="ContainerComponent",ce.__docgenInfo={description:"",displayName:"ContainerComponent",props:{target:{defaultValue:null,description:"",name:"target",required:!0,type:{name:"Element & { ref?: MutableRefObject<HTMLImageElement>; }"}},id:{defaultValue:null,description:"",name:"id",required:!1,type:{name:"string"}}}}}catch{}function Le({target:e,children:t,id:n}){const r=W();return Nt([{shortcut:["delete","backspace"],handler:i=>{i.isTrusted&&r({type:"REMOVE_ROI",payload:void 0})}},{shortcut:["Escape"],handler:i=>{i.preventDefault(),i.isTrusted&&r({type:"CANCEL_ACTION",payload:i})}}]),d.jsx(ce,{id:n,target:e,children:t})}try{Le.displayName="RoiContainer",Le.__docgenInfo={description:"",displayName:"RoiContainer",props:{target:{defaultValue:null,description:"",name:"target",required:!1,type:{name:"Element"}},id:{defaultValue:null,description:"",name:"id",required:!1,type:{name:"string"}}}}}catch{}function A(e,t){throw new Error(`unreachable: ${t||(typeof e=="string"?e:"reached assertUnreachable")}`)}function v(e,t){if(!e)throw new Error(`unreachable${t?`: ${t}`:""}`)}function xn(e){const{x:t,y:n,width:r,height:i}=e;return[{xPosition:"left",yPosition:"top",cursor:"nwse-resize",cx:t,cy:n},{xPosition:"left",yPosition:"bottom",cursor:"nesw-resize",cx:t,cy:n+i},{xPosition:"right",yPosition:"bottom",cursor:"nwse-resize",cx:t+r,cy:n+i},{cursor:"nesw-resize",xPosition:"right",yPosition:"top",cx:t+r,cy:n},{xPosition:"middle",yPosition:"top",cursor:"ns-resize",cx:t+r/2,cy:n},{xPosition:"middle",yPosition:"bottom",cursor:"ns-resize",cx:t+r/2,cy:n+i},{xPosition:"left",yPosition:"middle",cursor:"ew-resize",cx:t,cy:n+i/2},{xPosition:"right",yPosition:"middle",cursor:"ew-resize",cx:t+r,cy:n+i/2}]}function ae({id:e,x:t,y:n,width:r,height:i,style:o,label:s,className:c}){const a=W(),u=ge();return d.jsx("div",{id:e,style:{position:"absolute",left:t,top:n,width:r,height:i,cursor:u.mode==="draw"?"crosshair":"grab",...o},className:c,onMouseDown:f=>{f.altKey||(a({type:"SELECT_BOX_AND_START_MOVE",payload:{id:e}}),u.mode==="select"&&f.stopPropagation())},children:s})}try{ae.displayName="Box",ae.__docgenInfo={description:"",displayName:"Box",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},x:{defaultValue:null,description:"",name:"x",required:!0,type:{name:"number"}},y:{defaultValue:null,description:"",name:"y",required:!0,type:{name:"number"}},width:{defaultValue:null,description:"",name:"width",required:!0,type:{name:"number"}},height:{defaultValue:null,description:"",name:"height",required:!0,type:{name:"number"}},style:{defaultValue:null,description:"",name:"style",required:!1,type:{name:"CSSProperties"}},className:{defaultValue:null,description:"",name:"className",required:!1,type:{name:"string"}},label:{defaultValue:null,description:"",name:"label",required:!1,type:{name:"ReactNode"}}}}}catch{}const Z=4;function ue({corner:e,roiId:t}){const n=W();return d.jsx("div",{id:`corner-${e.xPosition}-${e.yPosition}`,style:{backgroundColor:"#44aaff",opacity:.5,stroke:"black",position:"absolute",top:e.cy-Z,left:e.cx-Z,width:Z*2,height:Z*2,cursor:e.cursor},onMouseDown:r=>{r.altKey||(r.stopPropagation(),n({type:"START_RESIZE",payload:{id:t,xAxisCorner:e.xPosition,yAxisCorner:e.yPosition}}))}})}try{ue.displayName="RoiBoxCorner",ue.__docgenInfo={description:"",displayName:"RoiBoxCorner",props:{corner:{defaultValue:null,description:"",name:"corner",required:!0,type:{name:"CornerData"}},roiId:{defaultValue:null,description:"",name:"roiId",required:!0,type:{name:"string"}}}}}catch{}function wn(e){const{roi:t,getStyle:n}=e,r=ge(),{x:i,y:o,width:s,height:c,id:a,label:u}=t,f=a===r.selectedRoi;return d.jsxs(d.Fragment,{children:[d.jsx(ae,{id:a,x:i,y:o,width:s,height:c,label:u,...n(t,f)}),r.mode==="select"&&f&&xn(t).map(y=>d.jsx(ue,{corner:y,roiId:a},`corner-${y.xPosition}-${y.yPosition}`))]})}const le=l.memo(wn);try{le.displayName="RoiBox",le.__docgenInfo={description:"",displayName:"RoiBox",props:{roi:{defaultValue:null,description:"",name:"roi",required:!0,type:{name:"Roi<unknown>"}},getStyle:{defaultValue:null,description:"",name:"getStyle",required:!0,type:{name:"(roi: Roi<unknown>, selected: boolean) => StyleProperties"}}}}}catch{}function Fe(e){const{getStyle:t=Rn}=e,n=vn();return d.jsx(d.Fragment,{children:n.map(r=>d.jsx(le,{roi:r,getStyle:t},r.id))})}function Rn(e,t){return{style:{backgroundColor:"black",opacity:t?.2:.5}}}try{Fe.displayName="RoiList",Fe.__docgenInfo={description:"",displayName:"RoiList",props:{getStyle:{defaultValue:null,description:"",name:"getStyle",required:!1,type:{name:"(roi: Roi<TData>, selected: boolean) => StyleProperties"}}}}}catch{}function b(e,t){return e/t}function q(e,t){return e*t}function Cn(e,t){const{x:n,y:r,width:i,height:o}=e;return{x:b(n,t.width),y:b(r,t.height),width:b(i,t.width),height:b(o,t.height)}}function D(e,t){const{x:n,y:r,width:i,height:o}=e;return{x:q(n,t.width),y:q(r,t.height),width:q(i,t.width),height:q(o,t.height)}}function En(){return{x:0,y:0,width:0,height:0}}function st(e,t={}){return{id:e,label:"",...En(),...t}}function ct(e,t,n={}){const r=st(e,n);return{...r,action:{type:"idle"},...n,...D(r,t)}}function On(e,t){const{action:n,...r}=e;return{...r,x:b(e.x,t.width),y:b(e.y,t.height),width:b(e.width,t.width),height:b(e.height,t.height)}}function Sn(e,t){const{...n}=e;return{...n,action:{type:"idle"},...D(e,t)}}function zn(e,t,n){const r=n.width/t.width,i=n.height/t.height;return{x:e.x*r,y:e.y*i,width:e.width*r,height:e.height*i}}var at=Symbol.for("immer-nothing"),$e=Symbol.for("immer-draftable"),h=Symbol.for("immer-state");function m(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var z=Object.getPrototypeOf;function P(e){return!!e&&!!e[h]}function R(e){var t;return e?ut(e)||Array.isArray(e)||!!e[$e]||!!((t=e.constructor)!=null&&t[$e])||H(e)||Y(e):!1}var Pn=Object.prototype.constructor.toString();function ut(e){if(!e||typeof e!="object")return!1;const t=z(e);if(t===null)return!0;const n=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return n===Object?!0:typeof n=="function"&&Function.toString.call(n)===Pn}function B(e,t){U(e)===0?Object.entries(e).forEach(([n,r])=>{t(n,r,e)}):e.forEach((n,r)=>t(r,n,e))}function U(e){const t=e[h];return t?t.type_:Array.isArray(e)?1:H(e)?2:Y(e)?3:0}function de(e,t){return U(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function lt(e,t,n){const r=U(e);r===2?e.set(t,n):r===3?e.add(n):e[t]=n}function Tn(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function H(e){return e instanceof Map}function Y(e){return e instanceof Set}function _(e){return e.copy_||e.base_}function fe(e,t){if(H(e))return new Map(e);if(Y(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);if(!t&&ut(e))return z(e)?{...e}:Object.assign(Object.create(null),e);const n=Object.getOwnPropertyDescriptors(e);delete n[h];let r=Reflect.ownKeys(n);for(let i=0;i<r.length;i++){const o=r[i],s=n[o];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(n[o]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[o]})}return Object.create(z(e),n)}function be(e,t=!1){return G(e)||P(e)||!R(e)||(U(e)>1&&(e.set=e.add=e.clear=e.delete=kn),Object.freeze(e),t&&B(e,(n,r)=>be(r,!0))),e}function kn(){m(2)}function G(e){return Object.isFrozen(e)}var An={};function C(e){const t=An[e];return t||m(0,e),t}var I;function dt(){return I}function Dn(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function je(e,t){t&&(C("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function he(e){pe(e),e.drafts_.forEach(Bn),e.drafts_=null}function pe(e){e===I&&(I=e.parent_)}function Ze(e){return I=Dn(I,e)}function Bn(e){const t=e[h];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function qe(e,t){t.unfinalizedDrafts_=t.drafts_.length;const n=t.drafts_[0];return e!==void 0&&e!==n?(n[h].modified_&&(he(t),m(4)),R(e)&&(e=X(t,e),t.parent_||K(t,e)),t.patches_&&C("Patches").generateReplacementPatches_(n[h].base_,e,t.patches_,t.inversePatches_)):e=X(t,n,[]),he(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==at?e:void 0}function X(e,t,n){if(G(t))return t;const r=t[h];if(!r)return B(t,(i,o)=>Ve(e,r,t,i,o,n)),t;if(r.scope_!==e)return t;if(!r.modified_)return K(e,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const i=r.copy_;let o=i,s=!1;r.type_===3&&(o=new Set(i),i.clear(),s=!0),B(o,(c,a)=>Ve(e,r,i,c,a,n,s)),K(e,i,!1),n&&e.patches_&&C("Patches").generatePatches_(r,n,e.patches_,e.inversePatches_)}return r.copy_}function Ve(e,t,n,r,i,o,s){if(P(i)){const c=o&&t&&t.type_!==3&&!de(t.assigned_,r)?o.concat(r):void 0,a=X(e,i,c);if(lt(n,r,a),P(a))e.canAutoFreeze_=!1;else return}else s&&n.add(i);if(R(i)&&!G(i)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;X(e,i),(!t||!t.scope_.parent_)&&K(e,i)}}function K(e,t,n=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&be(t,n)}function In(e,t){const n=Array.isArray(e),r={type_:n?1:0,scope_:t?t.scope_:dt(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=r,o=_e;n&&(i=[r],o=M);const{revoke:s,proxy:c}=Proxy.revocable(i,o);return r.draft_=c,r.revoke_=s,c}var _e={get(e,t){if(t===h)return e;const n=_(e);if(!de(n,t))return Mn(e,n,t);const r=n[t];return e.finalized_||!R(r)?r:r===ie(e.base_,t)?(oe(e),e.copy_[t]=me(r,e)):r},has(e,t){return t in _(e)},ownKeys(e){return Reflect.ownKeys(_(e))},set(e,t,n){const r=ft(_(e),t);if(r!=null&&r.set)return r.set.call(e.draft_,n),!0;if(!e.modified_){const i=ie(_(e),t),o=i==null?void 0:i[h];if(o&&o.base_===n)return e.copy_[t]=n,e.assigned_[t]=!1,!0;if(Tn(n,i)&&(n!==void 0||de(e.base_,t)))return!0;oe(e),ye(e)}return e.copy_[t]===n&&(n!==void 0||t in e.copy_)||Number.isNaN(n)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=n,e.assigned_[t]=!0),!0},deleteProperty(e,t){return ie(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,oe(e),ye(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const n=_(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:r.enumerable,value:n[t]}},defineProperty(){m(11)},getPrototypeOf(e){return z(e.base_)},setPrototypeOf(){m(12)}},M={};B(_e,(e,t)=>{M[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});M.deleteProperty=function(e,t){return M.set.call(this,e,t,void 0)};M.set=function(e,t,n){return _e.set.call(this,e[0],t,n,e[0])};function ie(e,t){const n=e[h];return(n?_(n):e)[t]}function Mn(e,t,n){var i;const r=ft(t,n);return r?"value"in r?r.value:(i=r.get)==null?void 0:i.call(e.draft_):void 0}function ft(e,t){if(!(t in e))return;let n=z(e);for(;n;){const r=Object.getOwnPropertyDescriptor(n,t);if(r)return r;n=z(n)}}function ye(e){e.modified_||(e.modified_=!0,e.parent_&&ye(e.parent_))}function oe(e){e.copy_||(e.copy_=fe(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var Nn=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(t,n,r)=>{if(typeof t=="function"&&typeof n!="function"){const o=n;n=t;const s=this;return function(a=o,...u){return s.produce(a,f=>n.call(this,f,...u))}}typeof n!="function"&&m(6),r!==void 0&&typeof r!="function"&&m(7);let i;if(R(t)){const o=Ze(this),s=me(t,void 0);let c=!0;try{i=n(s),c=!1}finally{c?he(o):pe(o)}return je(o,r),qe(i,o)}else if(!t||typeof t!="object"){if(i=n(t),i===void 0&&(i=t),i===at&&(i=void 0),this.autoFreeze_&&be(i,!0),r){const o=[],s=[];C("Patches").generateReplacementPatches_(t,i,o,s),r(o,s)}return i}else m(1,t)},this.produceWithPatches=(t,n)=>{if(typeof t=="function")return(s,...c)=>this.produceWithPatches(s,a=>t(a,...c));let r,i;return[this.produce(t,n,(s,c)=>{r=s,i=c}),r,i]},typeof(e==null?void 0:e.autoFreeze)=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof(e==null?void 0:e.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){R(e)||m(8),P(e)&&(e=Ln(e));const t=Ze(this),n=me(e,void 0);return n[h].isManual_=!0,pe(t),n}finishDraft(e,t){const n=e&&e[h];(!n||!n.isManual_)&&m(9);const{scope_:r}=n;return je(r,t),qe(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let n;for(n=t.length-1;n>=0;n--){const i=t[n];if(i.path.length===0&&i.op==="replace"){e=i.value;break}}n>-1&&(t=t.slice(n+1));const r=C("Patches").applyPatches_;return P(e)?r(e,t):this.produce(e,i=>r(i,t))}};function me(e,t){const n=H(e)?C("MapSet").proxyMap_(e,t):Y(e)?C("MapSet").proxySet_(e,t):In(e,t);return(t?t.scope_:dt()).drafts_.push(n),n}function Ln(e){return P(e)||m(10,e),ht(e)}function ht(e){if(!R(e)||G(e))return e;const t=e[h];let n;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,n=fe(e,t.scope_.immer_.useStrictShallowCopy_)}else n=fe(e,!0);return B(n,(r,i)=>{lt(n,r,ht(i))}),t&&(t.finalized_=!1),n}var p=new Nn,Fn=p.produce;p.produceWithPatches.bind(p);p.setAutoFreeze.bind(p);p.setUseStrictShallowCopy.bind(p);p.applyPatches.bind(p);p.createDraft.bind(p);p.finishDraft.bind(p);function $n(e){const t=e.rois.filter(r=>r.action.type!=="idle");if(t.length===0)return;v(t.length===1,"Multiple rois are being edited at the same time");const n=t[0];if(n.action.type==="drawing"){const r=e.rois.findIndex(i=>i.id===n.id);e.rois.splice(r,1)}else{const r=e.committedRois.find(i=>i.id===n.id);v(r),Object.assign(n,D(r,e.size))}e.action="idle",n.action={type:"idle"}}function jn(e,t){const n={x:e.x,y:e.y,width:e.width,height:e.height};return t==="drawing"||t==="resizing"?(n.x<0&&(n.width+=n.x,n.x=0),n.y<0&&(n.height+=n.y,n.y=0),n.height+n.y>1&&(n.height=1-n.y),n.width+n.x>1&&(n.width=1-n.x)):(n.x<0&&(n.x=0),n.y<0&&(n.y=0),n.x+n.width>1&&(n.x=1-n.width),n.y+n.height>1&&(n.y=1-n.height)),n}function Xe(e,t,n){const r=jn(Cn(n,e.size),n.action.type);r.height===0||r.width===0||Object.assign(t,r),Object.assign(n,D(t,e.size))}function Zn(e){e.action="idle";const{selectedRoi:t,rois:n,committedRois:r}=e;if(!t)return;const i=n.find(s=>s.id===t),o=r.find(s=>s.id===t);if(v(i,"Selected ROI not found"),!!i){if(o)v(i.action.type!=="drawing","Drawing ROI should not be commited"),Xe(e,o,i);else{v(i.action.type==="drawing");const s=On(i,e.size);Xe(e,s,i),e.committedRois.push(s)}i.action={type:"idle"}}}function qn(e,t){switch(e.action){case"idle":return;case"panning":e.panZoom.translation[0]+=t.movementX,e.panZoom.translation[1]+=t.movementY;return;case"moving":case"drawing":case"resizing":{const{selectedRoi:n,rois:r}=e,i=r.find(o=>o.id===n);v(i),Vn(e,i,{x:t.movementX,y:t.movementY});return}default:A(e.action,"Invalid action type")}}function Vn(e,t,n){const r=n.x/e.panZoom.scale,i=n.y/e.panZoom.scale;switch(t.action.type){case"idle":return;case"moving":t.x+=r,t.y+=i;break;case"resizing":{Ke(e,t,n);break}case"drawing":Ke(e,t,n);break;default:A(t.action,"Invalid action type")}}function Ke(e,t,n){v(t.action.type==="resizing"||t.action.type==="drawing");const r=n.x/e.panZoom.scale,i=n.y/e.panZoom.scale,o=t.action.xAxisCorner;switch(o){case"left":{const c=t.x+r;c<=t.x+t.width?(t.x=c,t.width-=r):(t.x=t.x+t.width,t.width=c-t.x,t.action.xAxisCorner="right");break}case"right":{const c=t.width+r;c>=0?t.width=c:(t.x=t.x+c,t.width=-c,t.action.xAxisCorner="left");break}case"middle":break;default:A(o)}const s=t.action.yAxisCorner;switch(s){case"top":{const c=t.y+i;c<=t.y+t.height?(t.y=c,t.height-=i):(t.y=t.y+t.height,t.height=c-t.y,t.action.yAxisCorner="bottom");break}case"bottom":{const c=t.height+i;c>=0?t.height=c:(t.y=t.y+c,t.height=-c,t.action.yAxisCorner="top");break}case"middle":break;default:A(s)}}function pt(e,t){return(t-e.translation[0])/e.scale}function yt(e,t){return(t-e.translation[1])/e.scale}function Xn(e,t){const{event:n,containerBoundingRect:r}=t,i=ct(crypto.randomUUID(),e.size);if(t.isPanZooming){e.action="panning";return}switch(e.mode){case"draw":{const o=pt(e.panZoom,n.clientX-r.x),s=yt(e.panZoom,n.clientY-r.y),c={...i,action:{type:"drawing",xAxisCorner:"left",yAxisCorner:"top"},x:o,y:s,width:0,height:0,data:void 0};e.selectedRoi=c.id,e.rois.push(c),e.action="drawing";break}case"select":{e.selectedRoi=void 0;break}}}const Kn=10,Wn=.5;function Un(e,t){const{scale:n,refBoundingClientRect:r,clientX:i,clientY:o}=t,{scale:s,translation:c}=e.panZoom,a=Math.max(Wn,Math.min(s*n,Kn)),u=i-r.left,f=o-r.top,y=pt(e.panZoom,u),J=yt(e.panZoom,f);e.panZoom.scale=a,c[0]=(s-a)*y+c[0],c[1]=(s-a)*J+c[1]}function Hn(e){e.panZoom.scale=1,e.panZoom.translation=[0,0]}function Yn(e,t){return Fn(e,n=>{const r=t.type;switch(r){case"SET_MODE":n.mode=t.payload;break;case"SET_SIZE":{if(t.payload.width===0||t.payload.height===0)return;n.rois.forEach(i=>{Object.assign(i,zn(i,n.size,t.payload))}),n.size=t.payload;break}case"REMOVE_ROI":{const i=t.payload??n.selectedRoi,o=n.rois.findIndex(s=>s.id===i);if(o===-1)return;n.rois.splice(o,1),n.committedRois.splice(o,1),n.selectedRoi=void 0;return}case"CREATE_ROI":{const{id:i,...o}=t.payload,s=st(i,o);n.committedRois.push(s),n.rois.push(ct(i,n.size,o)),n.selectedRoi=s.id;break}case"UPDATE_ROI":{const{id:i,...o}=t.payload;if(!i)return;const s=n.committedRois.find(a=>a.id===i),c=n.rois.find(a=>a.id===i);v(c,"ROI not found"),v(s,"Commited ROI not found"),Object.assign(s,o),Object.assign(c,o);break}case"START_RESIZE":{const{id:i,xAxisCorner:o,yAxisCorner:s}=t.payload,{rois:c}=n,a=c.find(u=>u.id===i);v(a,"ROI not found"),n.action="resizing",a.action={type:"resizing",xAxisCorner:o,yAxisCorner:s};break}case"SELECT_BOX_AND_START_MOVE":{const{id:i}=t.payload;if(!i)return;if(n.mode==="draw"){n.selectedRoi=void 0;return}const{rois:o}=n;n.selectedRoi=i;const s=o.find(c=>c.id===i);v(s,"ROI not found"),n.action="moving",s.action={type:"moving"};break}case"START_DRAW":{Xn(n,t.payload);break}case"MOUSE_MOVE":{qn(n,t.payload);break}case"END_ACTION":{Zn(n);break}case"CANCEL_ACTION":{$n(n);break}case"ZOOM":Un(n,t.payload);break;case"RESET_ZOOM":Hn(n);break;default:A(r)}})}function Gn(e){const t={width:1,height:1};return{mode:"select",action:"idle",size:t,selectedRoi:void 0,committedRois:e,rois:e.map(r=>Sn(r,t)),panZoom:{scale:1,translation:[0,0]}}}function We({children:e,initialRois:t=[]}){const n=Gn(t),[r,i]=l.useReducer(Yn,n),{rois:o,committedRois:s,mode:c,selectedRoi:a,panZoom:u}=r,f=l.useMemo(()=>({mode:c,selectedRoi:a}),[c,a]);return d.jsx(Mt,{children:d.jsx(Qe.Provider,{value:u,children:d.jsx(Ge.Provider,{value:i,children:d.jsx(Je.Provider,{value:o,children:d.jsx(Lt.Provider,{value:s,children:d.jsx(Ye.Provider,{value:f,children:e})})})})})})}try{We.displayName="RoiProvider",We.__docgenInfo={description:"",displayName:"RoiProvider",props:{initialRois:{defaultValue:{value:"[]"},description:"",name:"initialRois",required:!1,type:{name:"CommittedRoi<T>[]"}}}}}catch{}export{ae as B,We as R,Le as a,Fe as b,ge as c,W as u};
//# sourceMappingURL=RoiProvider-d71e6690.js.map
